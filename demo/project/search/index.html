<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
	<title>Title</title>
	<link rel="stylesheet" href="css/style.css">
	<script src="js/jsonp.js"></script>
</head>
<body>
	<p class="desc"><span>注：</span>搜索引擎可选，智能提示联想词，跳转指定关键词页面。</p>
	<div class="container">
		<div class="search-wbesite" id="search-wbesite">
			<a href="##" class="logo">Let'sGo</a>
			<ul>
				<li class="checked" data-index="1">淘宝</li>
				<li data-index="2">百度</li>
				<li data-index="3">360好搜</li>
				<li data-index="4">必应</li>
				<li data-index="5">豆瓣</li>
			</ul>
			<div class="search-checked" id="navigation">
				淘宝
			</div>
		</div>
		<form action="https://s.taobao.com/search" class="search-form"  id="search-form" method="get" accept-charset="utf-8"  target="_blank" >
			<input type="text" class="search-text" name="q" id="search_input" autocomplete="off" maxlength="50" placeholder="请输入要输入要搜索的内容">
			<button type="submit" class="search-button" id="submit_btn"><i></i></button>
		</form>
	</div>
	<div class="suggest" id="search-suggest"></div>
	<script>
		(function () {
		    "use strict";
			var data=[
					{name:"taobao",action:"https://s.taobao.com/search",url:"https://suggest.taobao.com/sug?code=utf-8",valueType:"q",callType:"callback",get:"result",dataType:"jsonp"},
					{name:"baidu",action:"https://www.baidu.com/s?wd=",url:"https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su",valueType:"wd",callType:"cb",get:"s",dataType:"jsonp"},
					{name:"360",action:"https://www.so.com/s",url:"https://sug.so.360.cn/suggest?encodein=utf-8&encodeout=utf-8&format=json",valueType:"word",callType:"callback",get:"result",dataType:"jsonp"},
					{name:"bing",action:"https://cn.bing.com/search",url:"https://api.bing.com/qsonhs.aspx?type=cb",valueType:"q",callType:"cb",get:"AS",dataType:"jsonp"},
					{name:"douban",action:"https://book.douban.com/subject_search",url:"http://api.douban.com/book/subjects?alt=xd",valueType:"q",callType:"callback",dataType:"jsonp",get:"entry"}
				],
                json=data[0],//json初始化为淘宝搜索数据，点击搜索项时切换其他搜索数据
			    doc =document,
				indexHight=-1,//控制弹框列表索引
				forEach=Array.prototype.forEach,
				search_form=doc.querySelectorAll("#search-form")[0],
				search_input=doc.querySelectorAll("#search_input")[0],
                suggest=doc.querySelectorAll("#search-suggest")[0],
                navigation=doc.querySelectorAll("#navigation")[0],
				search_web=doc.querySelectorAll("#search-wbesite li");


			forEach.call(search_web,function (item,index) {  //切换搜索
				item.addEventListener("click",function () {
                    forEach.call(search_web,function (item) {
	                   item.className="";
                    });
				    this.className ="checked";
                    suggest.innerHTML="";
                    search_input.value="";
                    search_form.action =data[index].action;
                    navigation.innerHTML =this.innerHTML;
                    json=data[index];
                },false);
            });

			window.onload=window.onresize=function () { //初始化搜索单框
                suggest.style.left=getPos(search_input,"Left")+"px";
                suggest.style.top=getPos(search_input,"Top")+53+"px";
            };

			search_input.addEventListener("keyup",function (e) {
	            var searchText=this.value,
                    oldString="",
		            event =e||window.event,
		            keyCode =event.keyCode,
		            nodeList=null;//弹框信息列表

				if(json.name=="baidu"){
                    search_form.action=json.action+searchText;
                    console.log(search_form.action);
				}

				if(searchText==""||searchText==null){
                    suggest.innerHTML="";
                    return
                }

				if(oldString ==searchText){//检查是否已经存在相同信息，减少响应查询
	                return
	            }
				oldString =searchText;
	            if(keyCode >= 65 && keyCode <= 90 || keyCode >= 48 && keyCode <= 57 || keyCode >= 96 && keyCode <= 111 || keyCode >= 186 && keyCode <= 222 || keyCode == 8 || keyCode == 46 ){   //响应查询的键码 字母键，（退格8），（删除46），（回车13）

		            myAjax({
		               url:json.url,
			            dataType:json.dataType,
			            valueType:json.valueType,
			            value:searchText,
                        callType:json.callType,
			            success:function (response) {
//		                   console.log(response);
                            var data =response[json.get],
                                html="";
//                            console.log(data.Results);
                            if((Object.prototype.toString.call(data) === '[object Array]')){
                                if(!data.length) return
                            }
                            if(Object.prototype.toString.call(data) === '[object Object]'&&!data.Results){
//                                console.log(data);
                                return
                            }
                            switch (json.name){
                                case "taobao":
                                    data.forEach(function (item) {
                                        html +="<div class='txt'>"+item[0]+"</div>";
                                    });
                                    break;
                                case "baidu":
                                    data.forEach(function (item) {
                                        html +="<a class='txt' href='"+search_form.action+"'>"+item+"</a>";
                                    });
                                    break;
                                case "360":
                                    console.log(data);
                                    data.forEach(function (item) {
                                        html +="<div class='txt'>"+item.word+"</div>";
                                    });
                                    break;
                                case "bing":
		                            console.log(data.Results);
                                    var array =data.Results[0].Suggests,
                                        url="";
                                    array.forEach(function (item) {
                                        html +="<div class='txt'>"+item.Txt+"</div>";
                                    });
//                                    console.log(html);
                                    break;
	                            case "douban":
	                                data.forEach(function (item) {
                                        html +="<div class='txt'>"+item.title.$t+"</div>";
                                    });
	                                break;
                            }
                            suggest.innerHTML =html;
                            suggest.style.display="block";

//                            nodeList =suggest.querySelectorAll(".txt");
//                            forEach.call(nodeList,function (item) { //弹框列表绑定事件，提交表单
//                                item.onclick =function () {
//                                    search_input.value =item.innerHTML;
//                                    search_form.submit();
//                                    search_input.blur();
//                                    indexHight=-1;
//                                }
//                            });
                        }
		            });
	            }else if(keyCode ==38||keyCode==40){//触发键码 向下38） （向上40）
	                console.log(suggest.innerHTML);
				    if(search_input.value!==""||suggest.innerHTML) {//检查输入框不为空，弹框有列表项
				        var len=0;  //存放列表项数目，初始化为0
				        nodeList =suggest.querySelectorAll(".txt");
                        len=nodeList.length;
                        forEach.call(nodeList,function (item) {
                            if( item.classList.contains("current")){
                                item.classList.remove("current");
                            }
                        });
				        if(keyCode ==40){
//                            console.log(indexHight);
                            indexHight++;
                            if(indexHight !==-1){
                                nodeList[indexHight].classList.add("current");
                                search_input.value =nodeList[indexHight].innerHTML;
                            }
				            if(indexHight ===len-1){
				                indexHight=-1;
				            }

				        }else if(keyCode ==38){
                            console.log(indexHight);
                            indexHight>=0&&indexHight--;
                            if(indexHight ==-1){
                                indexHight =len-1;
                            }
                            if(indexHight !==-1){
                                nodeList[indexHight].classList.add("current");
                                search_input.value =nodeList[indexHight].innerHTML;
                            }
				        }else if(keyCode ==13){
                            if(indexHight!=-1){
                                suggest.innerHTML="";
                                suggest.style.display="none";
                                indexHight=-1;
                            }else{
                                search_input.blur();
                            }
                        }
                    }
				}

            },false);


            search_input.addEventListener("focus",function (e) {
	           if(suggest.innerHTML){
                   suggest.style.display="block";
	           }
            });

            search_form.addEventListener("submit",function (e) {//原始的百度数据 提交之后自动清除跳到百度首页，此处阻止提交行为，自定义打开要搜索的关键词
	            var e=e||window.event;
	            if(json.name=="baidu"){//针对百度的hack手段
	                e.preventDefault();
	                window.open(search_form.action,"_blank");
	            }
            });

            suggest.addEventListener("click",function (e) {
                var target=e.target||window.event;
                if(target.className=="txt"){
                    search_input.value =target.innerHTML;
                    if(json.name!=="baidu"){//百度数据有问题，提交不验证，此处忽略
                        search_form.submit();
                    }
                    search_input.blur();
                    indexHight=-1;
                }
            });

			doc.onclick =function (e) {
			    var tar =e.target||window.event.srcElement;
			    if(tar !=suggest&&tar !==search_input){
                    if(suggest.style.display=="block"){
                        suggest.style.display="none";
                    }
			    }
            };

//			function $(tag) {
//			    var doc =document;
//				if(tag.substr(0,1)==="#"){
//				    return doc.getElementById(tag.substr(1));
//				}else if(tag.substr(0,1)=="."){
//				    return doc.getElementsByClassName(tag.substr(1));
//				}else if(/^[a-zA-Z_]+\d?$/g.test(tag)){
//                    return doc.getElementsByTagName(tag);
//                }
//            }
            function getPos(element,pos) {
                var actpos =element["offset"+pos],
                    current =element.offsetParent;
                while(current){
                    actpos +=current["offset"+pos];
                    current =current.offsetParent;
                }
                return actpos;
            }

        })();

	</script>
</body>
</html>